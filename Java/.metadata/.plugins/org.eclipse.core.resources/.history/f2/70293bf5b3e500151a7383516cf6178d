package com.vogella.jersey.first;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
 
import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
 

 
@Path("/message")
public class MessageResource {
	
	
	private static Database_connection link = new Database_connection();
	private static PreparedStatement prep_sql;
    
    @GET
    @Path("ping")
    public String getServerTime() {
        System.out.println("RESTful Service 'MessageService' is running ==> ping!");
        return "received ping on "+new Date().toString();
    }
    
    @GET
    @Produces({MediaType.APPLICATION_JSON})  //add MediaType.APPLICATION_XML if you want XML as well (don't forget @XmlRootElement)
    public List<Message> getAllMessages() throws Exception{
        
        List<Message> messages = new ArrayList<>();
        
        Message m = new Message();
        m.setDate(new Date());
        m.setFirstName("Nabi");
        m.setLastName("Zamani");
        m.setText("Hello World!");
        messages.add(m);
        
        System.out.println("getAllMessages(): found "+messages.size()+" message(s) on DB");
        
        return messages; //do not use Response object because this causes issues when generating XML automatically
    }
    
    @POST
    @Consumes({MediaType.APPLICATION_JSON})
    @Produces({MediaType.TEXT_PLAIN})
    @Path("/post")
    public String postMessage(Message msg) throws Exception{
        
        System.out.println("First Name = "+msg.getFirstName());
        System.out.println("Last Name  = "+msg.getLastName());
        
        
        
        
        
        
        
        
        
        
        link.Open_link();
		

		
		try{
			String query_monthly_update_date = "INSERT INTO test (`key`, `value`) VALUES (?, ?);";
			prep_sql = link.linea.prepareStatement(query_monthly_update_date);
			prep_sql.setString(1, msg.getFirstName());
			prep_sql.setString(2, msg.getLastName());
			
			prep_sql.executeUpdate();
			
			
			System.out.println("execute insert");
			
//				while(daily_update_date.next()){
//					//daily_update_dates[i] = daily_update_date.getString("MAX(update_date)");
//					output+=daily_update_date.getString("key");
//					output+=" ";
//					output+=daily_update_date.getString("value");
//					//System.out.println("key: " + daily_update_date.getString("key") + " value: " + daily_update_date.getString("value"));
//					output+=", ";
//				}
		}catch(Exception e){

			System.out.println("Error: " + e.getMessage());
			
			link.Close_link();
			
		//	output="Error connecting to database";
			
		//		output="Error connecting to database";
				
			  return "<html> " + "<title>" + "DB Hello Jersey" + "</title>"
			  + "<body><h1>" + "Error connecting to database" + "</body></h1>" + "</html> ";
			
			

		}

	link.Close_link();
        
        
        
        
        
	System.out.println("end");
        
        
        
        
        
        
        
        return "ok";
    }
      
}